<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Skillset</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { DEFAULT: '#F68B1F', light: '#F6B01E', dark: '#F55203' },
            accent: '#313131',
            success: '#0ea5e9',
            danger: '#ef4444',
          }
        }
      }
    }
  </script>
  <style>
    body { background: #f8fafc; color: #0f172a; }
    .card { background: #fff; border: 1px solid #e2e8f0; box-shadow: 0 12px 30px rgba(15,23,42,0.08); }
  </style>
</head>
<body class="antialiased">
  <div class="max-w-6xl mx-auto px-4 py-8 space-y-6">
    <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-full bg-primary text-white font-bold grid place-items-center">A</div>
        <div>
          <p class="text-lg font-semibold">Welcome back, <span data-user-name>Admin</span>!</p>
          <p class="text-sm text-slate-500">Admin Dashboard</p>
        </div>
      </div>
      <div class="ml-auto flex flex-wrap items-center justify-end gap-2 text-sm font-semibold">
        <a href="index.html" class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 transition">Home</a>
        <a href="dashboard.html" class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 transition">Client view</a>
        <a href="dashboard-expert.html" class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 transition">Expert view</a>
        <a href="login.html" class="px-3 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition" id="logout-btn">Log Out</a>
      </div>
    </header>

    <section class="grid md:grid-cols-3 gap-4">
      <div class="card rounded-2xl p-4">
        <p class="text-sm text-slate-500">Clients</p>
        <p class="text-3xl font-semibold" id="count-clients">--</p>
      </div>
      <div class="card rounded-2xl p-4">
        <p class="text-sm text-slate-500">Experts</p>
        <p class="text-3xl font-semibold" id="count-experts">--</p>
      </div>
      <div class="card rounded-2xl p-4">
        <p class="text-sm text-slate-500">Jobs</p>
        <p class="text-3xl font-semibold" id="count-jobs">--</p>
      </div>
    </section>

    <section class="grid lg:grid-cols-2 gap-4">
      <div class="card rounded-2xl p-5 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold text-lg">Add user</h2>
        </div>
        <form id="add-user-form" class="grid grid-cols-1 gap-3">
          <input class="border rounded-lg px-3 py-2" name="username" placeholder="Username" required>
          <input class="border rounded-lg px-3 py-2" name="email" placeholder="Email">
          <input class="border rounded-lg px-3 py-2" type="password" name="password" placeholder="Password (optional)">
          <select class="border rounded-lg px-3 py-2" name="role">
            <option value="client">Client</option>
            <option value="expert">Expert</option>
            <option value="admin">Admin</option>
          </select>
          <button class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90" type="submit">Create user</button>
        </form>
      </div>
      <div class="card rounded-2xl p-5 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold text-lg">Post a job</h2>
        </div>
        <form id="add-job-form" class="grid grid-cols-1 gap-3">
          <input class="border rounded-lg px-3 py-2" name="title" placeholder="Job title" required>
          <textarea class="border rounded-lg px-3 py-2" name="description" placeholder="Description"></textarea>
          <div class="grid grid-cols-2 gap-3">
            <input class="border rounded-lg px-3 py-2" name="budget" placeholder="Budget (number)" required>
            <input class="border rounded-lg px-3 py-2" name="location" placeholder="Location">
          </div>
          <button class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-500" type="submit">Publish job</button>
        </form>
      </div>
    </section>
    <!-- Escrow & milestones -->
    <section class="card rounded-2xl p-6 space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-600">Escrow workflow</p>
          <p class="text-lg font-semibold">Milestone states & timers</p>
        </div>
        <a href="dispute-center.html" class="text-sm text-amber-600 hover:text-amber-500">Open dispute center →</a>
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-sm text-slate-700">
          <thead class="text-left text-slate-600">
            <tr>
              <th class="px-3 py-2">Milestone</th>
              <th class="px-3 py-2">Amount</th>
              <th class="px-3 py-2">State</th>
              <th class="px-3 py-2">Auto-release</th>
              <th class="px-3 py-2">Actions</th>
            </tr>
          </thead>
          <tbody id="milestone-table">
            <tr class="border-b">
              <td class="px-3 py-2">Deposit 1</td>
              <td class="px-3 py-2">GHS 2,500</td>
              <td class="px-3 py-2">Submitted</td>
              <td class="px-3 py-2">3d 12h</td>
              <td class="px-3 py-2 space-x-2" data-admin-only>
                <button data-type="ms" data-id="demo-1" data-state="approved" class="px-2 py-1 rounded border border-slate-300 text-xs">Approve</button>
                <button data-type="ms" data-id="demo-1" data-state="revision" class="px-2 py-1 rounded border border-amber-300 text-amber-700 text-xs">Request revision</button>
              </td>
            </tr>
            <tr class="border-b">
              <td class="px-3 py-2">Final handover</td>
              <td class="px-3 py-2">GHS 1,800</td>
              <td class="px-3 py-2">In dispute</td>
              <td class="px-3 py-2">Paused</td>
              <td class="px-3 py-2 space-x-2" data-admin-only>
                <button data-type="ms" data-id="demo-2" data-state="frozen" class="px-2 py-1 rounded border border-red-300 text-red-700 text-xs">Freeze</button>
                <button data-type="ms" data-id="demo-2" data-state="partial_release" class="px-2 py-1 rounded border border-emerald-300 text-emerald-700 text-xs">Release partial</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <p class="text-xs text-slate-600">Auto-release is paused on disputes or revisions; admins can freeze, split, or refund.</p>
    </section>


    <section class="card rounded-2xl p-5 space-y-3">
      <div class="flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <h2 class="font-semibold text-lg">Clients</h2>
          <p class="text-slate-500 text-sm">Manage all client accounts</p>
        </div>
        <input id="filter-clients" class="border rounded-lg px-3 py-2 w-64" placeholder="Filter clients">
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-2 px-3">Username</th><th class="py-2 px-3">Email</th><th class="py-2 px-3">Actions</th>
            </tr>
          </thead>
          <tbody id="table-clients"></tbody>
        </table>
      </div>
    </section>
    


    <section class="card rounded-2xl p-5 space-y-3">
      <div class="flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <h2 class="font-semibold text-lg">Experts</h2>
          <p class="text-slate-500 text-sm">Manage expert accounts</p>
        </div>
        <input id="filter-experts" class="border rounded-lg px-3 py-2 w-64" placeholder="Filter experts">
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-2 px-3">Username</th><th class="py-2 px-3">Email</th><th class="py-2 px-3">Actions</th>
            </tr>
          </thead>
          <tbody id="table-experts"></tbody>
        </table>
      </div>
    </section>

    <section class="card rounded-2xl p-5 space-y-3">
      <div class="flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <h2 class="font-semibold text-lg">Proposals</h2>
          <p class="text-slate-500 text-sm">Review, accept, or counter proposals</p>
        </div>
        <input id="filter-proposals" class="border rounded-lg px-3 py-2 w-64" placeholder="Filter proposals">
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-2 px-3">Job</th>
              <th class="py-2 px-3">Expert</th>
              <th class="py-2 px-3">Price</th>
              <th class="py-2 px-3">Revisions</th>
              <th class="py-2 px-3">State</th>
              <th class="py-2 px-3">Actions</th>
            </tr>
          </thead>
          <tbody id="table-proposals"></tbody>
        </table>
      </div>
    </section>
    


    <section class="card rounded-2xl p-5 space-y-3">
      <div class="flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <h2 class="font-semibold text-lg">Jobs</h2>
          <p class="text-slate-500 text-sm">View, filter, and remove jobs</p>
        </div>
        <input id="filter-jobs" class="border rounded-lg px-3 py-2 w-64" placeholder="Filter jobs">
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-2 px-3">Title</th><th class="py-2 px-3">Budget</th><th class="py-2 px-3">Location</th><th class="py-2 px-3">Actions</th>
            </tr>
          </thead>
          <tbody id="table-jobs"></tbody>
        </table>
      </div>
    </section>
  </div>

    



  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    const API_BASE = 'http://127.0.0.1:8001/api';
    const token = localStorage.getItem('jwt_access');
    const role = localStorage.getItem('user_role');

    if (!token || role !== 'admin') {
      window.location.href = 'admin-login.html';
    }

    const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };

    const state = { users: [], jobs: [], proposals: [] };
    const milestoneTable = document.getElementById('milestone-table');
    const proposalTable = document.getElementById('table-proposals');

    function normalizeList(payload) {
      if (Array.isArray(payload)) return payload;
      if (payload && Array.isArray(payload.data)) return payload.data;
      if (payload && Array.isArray(payload.results)) return payload.results;
      return [];
    }

    function getRole(user) {
      if (user?.role) return user.role;
      if (user?.is_staff) return 'admin';
      if (user?.is_expert) return 'expert';
      if (user?.is_client) return 'client';
      return 'client';
    }

    function setCounts() {
      const clients = state.users.filter(u => getRole(u) === 'client');
      const experts = state.users.filter(u => getRole(u) === 'expert');
      document.getElementById('count-clients').textContent = clients.length;
      document.getElementById('count-experts').textContent = experts.length;
      document.getElementById('count-jobs').textContent = state.jobs.length;
    }

    function renderTables() {
      const clientFilter = document.getElementById('filter-clients').value.toLowerCase();
      const expertFilter = document.getElementById('filter-experts').value.toLowerCase();
      const jobFilter = document.getElementById('filter-jobs').value.toLowerCase();
      const proposalFilter = document.getElementById('filter-proposals')?.value.toLowerCase() || '';

      document.getElementById('table-clients').innerHTML = state.users
        .filter(u => {
          const name = (u.username || u.name || u.email || '').toLowerCase();
          const email = (u.email || '').toLowerCase();
          return getRole(u) === 'client' && (!clientFilter || name.includes(clientFilter) || email.includes(clientFilter));
        })
        .map(u => rowUser(u)).join('');
      document.getElementById('table-experts').innerHTML = state.users
        .filter(u => {
          const name = (u.username || u.name || u.email || '').toLowerCase();
          const email = (u.email || '').toLowerCase();
          return getRole(u) === 'expert' && (!expertFilter || name.includes(expertFilter) || email.includes(expertFilter));
        })
        .map(u => rowUser(u)).join('');
      document.getElementById('table-jobs').innerHTML = state.jobs
        .filter(j => {
          const title = (j.title || '').toLowerCase();
          const location = (j.location || '').toLowerCase();
          const description = (j.description || '').toLowerCase();
          return !jobFilter || title.includes(jobFilter) || location.includes(jobFilter) || description.includes(jobFilter);
        })
        .map(j => rowJob(j)).join('');
      if (proposalTable) {
        proposalTable.innerHTML = state.proposals
          .filter(p => {
            const job = (p.job?.title || p.job || '').toLowerCase();
            const expert = (p.expert?.name || p.expert || p.expert_name || '').toLowerCase();
            return !proposalFilter || job.includes(proposalFilter) || expert.includes(proposalFilter);
          })
          .map(p => rowProposal(p)).join('');
      }
      setCounts();
    }

    function renderMilestones(rows) {
      if (!milestoneTable) return;
      milestoneTable.innerHTML = rows.map(m => `
        <tr class="border-b">
          <td class="px-3 py-2">${m.title || m.name || 'Milestone'}</td>
          <td class="px-3 py-2">GHS ${m.amount || m.value || 0}</td>
          <td class="px-3 py-2">${m.state || 'pending'}</td>
          <td class="px-3 py-2">${m.auto_release || m.auto_release_at || '—'}</td>
          <td class="px-3 py-2 space-x-2 text-xs">
            <button data-type="ms" data-id="${m.id}" data-state="approved" class="px-2 py-1 rounded border border-slate-300">Approve</button>
            <button data-type="ms" data-id="${m.id}" data-state="in_dispute" class="px-2 py-1 rounded border border-amber-300 text-amber-700">Dispute</button>
            <button data-type="ms" data-id="${m.id}" data-state="frozen" class="px-2 py-1 rounded border border-red-300 text-red-700">Freeze</button>
            <button data-type="ms" data-id="${m.id}" data-state="partial_release" class="px-2 py-1 rounded border border-emerald-300 text-emerald-700">Release partial</button>
          </td>
        </tr>
      `).join('');
    }

    function rowUser(u) {
      const label = u.username || u.name || u.email || 'User';
      return `<tr class="border-b">
        <td class="py-2 px-3">${label}</td>
        <td class="py-2 px-3 text-slate-500">${u.email || ''}</td>
        <td class="py-2 px-3">
          <button class="text-danger hover:underline" onclick="deleteUser(${u.id})">Remove</button>
        </td>
      </tr>`;
    }

    function rowJob(j) {
      return `<tr class="border-b">
        <td class="py-2 px-3">${j.title}</td>
        <td class="py-2 px-3">${j.budget}</td>
        <td class="py-2 px-3 text-slate-500">${j.location || ''}</td>
        <td class="py-2 px-3">
          <button class="text-danger hover:underline" onclick="deleteJob(${j.id})">Remove</button>
        </td>
      </tr>`;
    }

    function rowProposal(p) {
      const jobLabel = p.job?.title || p.job || 'Job';
      const expertLabel = p.expert?.name || p.expert || p.expert_name || 'Expert';
      return `<tr class="border-b">
        <td class="py-2 px-3">${jobLabel}</td>
        <td class="py-2 px-3">${expertLabel}</td>
        <td class="py-2 px-3">GHS ${p.price || 0}</td>
        <td class="py-2 px-3">${p.revisions || 1}</td>
        <td class="py-2 px-3">${p.state || 'pending'}</td>
        <td class="py-2 px-3 space-x-2">
          <button data-type="pr" data-id="${p.id}" data-state="accepted" class="text-emerald-700 border border-emerald-300 px-2 py-1 rounded text-xs">Accept</button>
          <button data-type="pr" data-id="${p.id}" data-state="declined" class="border border-slate-300 px-2 py-1 rounded text-xs">Decline</button>
          <button data-type="pr" data-id="${p.id}" data-state="counter" class="text-amber-700 border border-amber-300 px-2 py-1 rounded text-xs">Counter</button>
        </td>
      </tr>`;
    }

    async function fetchUsers() {
      const res = await fetch(API_BASE + '/users/', { headers });
      if (!res.ok) throw new Error('Failed to load users');
      state.users = normalizeList(await res.json());
      renderTables();
    }

    async function fetchJobs() {
      const res = await fetch(API_BASE + '/jobs/', { headers });
      if (!res.ok) throw new Error('Failed to load jobs');
      state.jobs = normalizeList(await res.json());
      renderTables();
    }

    async function fetchProposals() {
      if (!proposalTable) return;
      const res = await fetch(API_BASE + '/proposals/', { headers });
      if (!res.ok) throw new Error('Failed to load proposals');
      state.proposals = normalizeList(await res.json());
      renderTables();
    }

    async function fetchMilestones() {
      if (!milestoneTable) return;
      const res = await fetch(API_BASE + '/milestones/', { headers });
      if (!res.ok) throw new Error('Failed to load milestones');
      const payload = normalizeList(await res.json());
      renderMilestones(payload);
    }

    async function deleteUser(id) {
      if (!confirm('Remove this user?')) return;
      const res = await fetch(API_BASE + '/users/' + id + '/', { method: 'DELETE', headers });
      if (res.ok) {
        state.users = state.users.filter(u => u.id !== id);
        renderTables();
        showToast('User removed');
      } else {
        showToast('Failed to remove user', 'error');
      }
    }

    async function deleteJob(id) {
      if (!confirm('Remove this job?')) return;
      const res = await fetch(API_BASE + '/jobs/' + id + '/', { method: 'DELETE', headers });
      if (res.ok) {
        state.jobs = state.jobs.filter(j => j.id !== id);
        renderTables();
        showToast('Job removed');
      } else {
        showToast('Failed to remove job', 'error');
      }
    }

    document.getElementById('add-user-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      const isAdmin = payload.role === 'admin';
      payload.is_staff = isAdmin;
      const res = await fetch(API_BASE + '/users/', { method: 'POST', headers, body: JSON.stringify(payload) });
      if (res.ok) {
        const created = await res.json();
        const record = created?.data || created;
        if (record) state.users.push(record);
        renderTables();
        showToast('User created');
        e.target.reset();
      } else {
        showToast('Failed to create user', 'error');
      }
    });

    document.getElementById('add-job-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      payload.budget = Number(payload.budget || 0);
      const res = await fetch(API_BASE + '/jobs/', { method: 'POST', headers, body: JSON.stringify(payload) });
      if (res.ok) {
        const created = await res.json();
        const record = created?.data || created;
        if (record) state.jobs.unshift(record);
        renderTables();
        showToast('Job posted');
        e.target.reset();
      } else {
        showToast('Failed to post job', 'error');
      }
    });

    ['filter-clients','filter-experts','filter-jobs','filter-proposals'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', renderTables);
    });

    document.getElementById('logout-btn').addEventListener('click', (e) => {
      localStorage.clear();
    });

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-type]');
      if (!btn) return;
      const id = btn.dataset.id;
      const state = btn.dataset.state;
      try {
        if (btn.dataset.type === 'ms') {
          const res = await fetch(API_BASE + '/milestones/' + id + '/', { method: 'PATCH', headers, body: JSON.stringify({ state }) });
          if (!res.ok) throw new Error('Failed to update milestone');
          fetchMilestones();
        }
        if (btn.dataset.type === 'pr') {
          const res = await fetch(API_BASE + '/proposals/' + id + '/', { method: 'PATCH', headers, body: JSON.stringify({ state }) });
          if (!res.ok) throw new Error('Failed to update proposal');
          fetchProposals();
        }
      } catch (err) {
        showToast('Update failed', 'error');
      }
    });

    // initial load
    fetchUsers().catch(err => showToast(err.message, 'error'));
    fetchJobs().catch(err => showToast(err.message, 'error'));
    fetchMilestones().catch(err => showToast(err.message, 'error'));
    fetchProposals().catch(err => showToast(err.message, 'error'));
  </script>
</body>
</html>










